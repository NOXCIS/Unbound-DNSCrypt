services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    volumes:
      - ./configs/dnscrypt-unbound/dnscrypt-proxy.toml:/config/dnscrypt-proxy.toml:ro
      - ./configs/dnscrypt-unbound/unbound.conf:/etc/unbound/unbound.conf:ro
      - ./configs/dnscrypt-unbound/custom.conf.d:/etc/unbound/custom.conf.d:ro
    cap_add:
      - NET_BIND_SERVICE
      - NET_ADMIN
    # Note: To fully use 4MB buffers, the Docker host (Linux VM on macOS) 
    # needs sysctls set. On macOS Docker Desktop, these are limited.
    # For production Linux hosts, you can add:
    # sysctls:
    #   - net.core.rmem_max=8388608
    #   - net.core.wmem_max=8388608
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s